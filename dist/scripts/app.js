app=angular.module("babysitting",["ui.router","ngAnimate","ngMaterial","firebase","ngMessages","ngOrderObjectBy"]),app.factory("$toast",function(){return function(e){document.getElementById("toast").className+="animate",document.querySelector("#toast span").innerHTML=e,setTimeout(function(){document.getElementById("toast").className=""},3e3)}}),app.config(["$stateProvider","$urlRouterProvider","$mdThemingProvider","$httpProvider",function(e,t,a,r){a.theme("default").primaryPalette("indigo").accentPalette("orange");var n;n="babysitting-3329b.firebaseapp.com"==window.location.hostname?"https://babysitting.herokuapp.com":"http://localhost:8080",r.interceptors.push(function(){return{request:function(e){return"POST"==e.method&&e.api&&(e.url=n+e.url),e}}}),t.otherwise("/babysitters"),e.state("login",{url:"/login",templateUrl:"pages/login.html",data:{pageTitle:"Login",guests:!0,icon:"vpn_key"},controller:"mainCtrl"}).state("booking",{url:"/booking/{uid}",templateUrl:"pages/booking.html",data:{pageTitle:"Booking",guests:!1,hidden:!0,icon:"event_note"},controller:"bookingCtrl"}).state("babysitters",{url:"/babysitters",templateUrl:"pages/babysitters.html",data:{pageTitle:"babysitters",guest:!1,icon:"people",parent:!0},controller:"babysittersCtrl"}).state("find",{url:"/find",templateUrl:"pages/find.html",data:{pageTitle:"Find",guest:!1,icon:"search",parent:!0},controller:"findCtrl"}).state("register",{url:"/register",templateUrl:"pages/register.html",replace:!0,data:{pageTitle:"Register",guests:!0,icon:"create"},params:{googleLogin:null},controller:"registerCtrl"}).state("accountPage",{url:"/account/{tab}",templateUrl:"pages/account.html",data:{pageTitle:"My Account",guests:!1,icon:"perm_identity"},controller:"accountCtrl"}).state("children",{url:"/children/{edit}",templateUrl:"pages/children.html",data:{pageTitle:"My children",hidden:!0,guests:!1},controller:"childrenCtrl"}).state("bookingDetails",{url:"/booking/info/{id}",templateUrl:"pages/bookingDetails.html",data:{pageTitle:"Booking information",hidden:!0,guests:!1},controller:"bookingDetails"}).state("about",{url:"/about",templateUrl:"pages/about.html",data:{pageTitle:"About",guests:!0,icon:"info_outline"}})}]),app.run(["$rootScope","$state","$stateParams","$firebaseObject","$toast","$firebaseAuth",function(e,t,a,r,n,o){e.$state=t,e.states=t.get(),e.states.shift(),e.availableStates=e.states,e.currentUserLoaded=!1,e.loggedIn=!1,e.authStateLoaded=!1,e.authData={},e.incompleteData=!1;var i={apiKey:"AIzaSyDL6RudaDzBsZmbPMGwfrpKiErSOqVJjQk",authDomain:"babysitting-3329b.firebaseapp.com",databaseURL:"https://babysitting-3329b.firebaseio.com",storageBucket:"babysitting-3329b.appspot.com"};firebase.initializeApp(i),e.authObj=o(),e.authObj.$onAuthStateChanged(function(a){e.authStateLoaded=!0,a?(e.loggedIn=!0,e.authData=JSON.parse(JSON.stringify(a))):(e.loggedIn=!1,t.go("login"))}),e.defaultAgeGroups=[{codename:"A",description:"Age group 1 - 2",rate:5},{codename:"B",description:"Age group 2 - 5",rate:5},{codename:"C",description:"Age group 5 - 8",rate:5},{codename:"D",description:"Age group 8 - 12",rate:5},{codename:"E",description:"Age group 12 - 16",rate:5}],e.days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],e.defaultWorkHours=[];for(var s=0;s<7;s++)e.defaultWorkHours.push({name:e.days[s],startTime:252e5,endTime:72e6});e.database=firebase.database().ref(),window.database=e.database,e.$on("$stateChangeStart",function(a,r,o,i,s,d){e.navOpen&&e.slideAway(),"booking"!=r.name||o.uid||(a.preventDefault(),n("Please choose a babysitter first"),t.go("babysitters")),"login"==r.name&&e.loggedIn&&!o.googleLogin&&(a.preventDefault(),t.go("babysitters")),e.authStateLoaded&&(r.data.guests||e.loggedIn||(a.preventDefault(),t.go("login"),n("Please Login First"))),e.incompleteData&&!r.data.guests&&"register"!==r&&(a.preventDefault(),n("Please finish registeration"))}),e.$watch("loggedIn",function(){e.loggedIn?(e.availableStates=e.states.filter(function(e){return!e.data.guests&&!e.data.hidden}),e.fetchUserData(firebase.auth().currentUser.uid)):e.availableStates=e.states.filter(function(e){return e.data.guests})}),e.fetchUserData=function(a){e.currentUser=r(e.database.child("users/"+a)),e.currentUser.$loaded().then(function(){e.currentUserLoaded=!0,null===e.currentUser.$value&&(e.incompleteData=!0,n("Please finish registeration"),t.go("register"))}),e.currentUser.$watch(function(){null!==e.currentUser.$value&&(e.incompleteData=!1)})}}]),app.controller("accountCtrl",["$scope","$rootScope","$toast","$state","$stateParams","$firebaseArray","$firebaseObject",function(e,t,a,r,n,o,i){e.children=[],e.zeroChildren=!1,e.childrenLoaded=!1,e.currentUserLoaded=!1,e.bookingsLoaded=!1,e.user={},e.pages={parent:"pages/parent.html",babysitter:"pages/babysitter.html",personal:"pages/personalInfo.html"},e.invalidPricingForm=!1,e.pricingLoaded=!1,e.pricingForm=[],e.ageGroups={},e.workHours=[],e.bookings=[],e.emptyBookings=!1,e.times=[];for(var s=0;s<=48;s++){var d={ms:18e5*s,format:moment().startOf("day").add(30*s,"m").format("hh:mm A")};e.times.push(d)}"parent"==n.tab&&(e.parentTab=!0),t.$watch("currentUserLoaded",function(){if(t.currentUser){e.currentUserLoaded=!0;var a=t.currentUser.$id;e.user={name:t.currentUser.name,locationCity:t.currentUser.locationCity,zipCode:t.currentUser.zipCode,street:t.currentUser.street},e.userTypes=[{icon:"person",description:"parent",model:angular.copy(t.currentUser.userType.parent)},{icon:"child_friendly",description:"babysitter",model:angular.copy(t.currentUser.userType.babySitter)}],e.workHours=angular.copy(t.currentUser.workHours),e.updatePricing(a),e.children=o(e.database.child("users/"+a+"/children")),e.children.$loaded().then(function(t){e.childrenLoaded=!0,0==t.length?e.zeroChildren=!0:e.zeroChildren=!1}),e.children.$watch(function(){0==e.children.length?e.zeroChildren=!0:e.zeroChildren=!1}),e.bookings=i(e.database.child("bookingStatus/"+a)),e.bookings.$loaded().then(function(t){e.bookingsLoaded=!0,null!==t.$value&&void 0===t.$value||(e.emptyBookings=!0)}).catch(function(e){})}}),e.updatePricing=function(a){e.database.child("babysitters/"+a+"/pricing").once("value").then(function(a){a.val()?e.ageGroups=a.val():e.ageGroups=angular.copy(t.defaultAgeGroups),e.pricingLoaded=!0,e.$apply()}).catch(function(e){})},e.workHours=angular.copy(t.defaultWorkHours),e.deleteChild=function(t){var r=e.children.indexOf(t);e.children.$remove(r).then(function(){a(t.name+" removed")}),0==e.children.length&&(e.zeroChildren=!0)},e.updateProfile=function(){var t={};t["users/"+e.currentUser.$id+"/name"]=e.user.name,t["users/"+e.currentUser.$id+"/locationCity"]=e.user.locationCity,e.currentUser.userType.parent?(t["users/"+e.currentUser.$id+"/zipCode"]=e.user.zipCode,t["users/"+e.currentUser.$id+"/street"]=e.user.street):(t["babysitters/"+e.currentUser.$id+"/name"]=e.user.name,t["babysitters/"+e.currentUser.$id+"/locationCity"]=e.user.locationCity),e.database.update(t).then(function(e){}).catch(function(e){})},e.updateUserType=function(r){var n="users/"+e.currentUser.$id,o=e.currentUser.$id;if("parent"===r.description){var i={};i[n+"/userType/parent"]=r.model,t.currentUser.userType.parent&&(i[n+"/children/"]=null),e.database.update(i).then(function(e){a("Successfully changed account")}).catch(function(e){})}if("babysitter"===r.description){var s={};s[n+"/userType/babySitter"]=r.model,t.currentUser.userType.babySitter?(s[n+"/pricing"]=null,s["babysitters/"+o]=null):(s["babysitters/"+o]={workHours:t.defaultWorkHours,pricing:t.defaultAgeGroups,photoURL:e.currentUser.photoURL,locationCity:e.currentUser.locationCity,birthDay:e.currentUser.birthDay,email:e.currentUser.email,name:e.currentUser.name},s["users/"+o+"/pricing"]=t.defaultAgeGroups,e.updatePricing(o)),e.database.update(s).then(function(e){a("Successfully changed account")}).catch(function(e){})}},e.saveHours=function(){var r={},n=t.currentUser.$id;e.workHoursToSave=e.workHours.map(function(e){return delete e.$$hashKey,e}),r["users/"+n+"/workHours/"]=r["babysitters/"+n+"/workHours"]=e.workHoursToSave,e.database.update(r).then(function(e){a("Hours updated")}).catch(function(e){a("Failed to update")})},e.savePricing=function(){var r={},n=t.currentUser.$id;e.ageGroupsToSave=e.ageGroups.map(function(e){return delete e.$$hashKey,e}),r["users/"+n+"/pricing/"]=r["babysitters/"+n+"/pricing/"]=e.ageGroupsToSave,e.database.update(r).then(function(e){a("Pricing updated")}).catch(function(e){a("Failed to update")})},e.checkForms=function(){for(var t=0;t<e.pricingForm.length;t++){if(e.pricingForm[t].$invalid){e.invalidPricingForm=!0;break}e.invalidPricingForm=!1}},e.showBookingInformation=function(e){r.go("bookingDetails",{id:e})}}]),app.controller("babysittersCtrl",["$scope","$state","$rootScope","$toast","$firebaseObject","$mdDialog","$anchorScroll",function(e,t,a,r,n,o,i){e.amount=10,e.babysittersLoaded=!1,e.noBabysitters=!1,e.max=!1,e.update=function(t,r){e.babysittersLoaded=!1;var o=a.database.child("babysitters/").limitToFirst(t);e.babysitters=n(o),e.babysitters.$loaded(function(){e.babysittersLoaded=!0,r&&setTimeout(function(){window.scrollTo(0,document.body.scrollHeight)}),null===e.babysitters.$value&&(e.noBabysitters=!0)})},e.update(e.amount,!1),e.loadMore=function(){return e.amount>Object.keys(e.babysitters).length-3?void(e.max=!0):(e.amount+=15,void e.update(e.amount,!0))},e.email=function(e){location.href="mailto:"+e+"?Subject=Regarding a booking"},e.moreInfo=function(t,a,r){e.uid=a,e.babysitter=t,o.show({contentElement:"#babySitterDialog",parent:angular.element(document.body),targetEvent:r,clickOutsideToClose:!0,bindToController:!0,fullscreen:!0})},e.calculateAge=function(e){return Math.abs(new Date(Date.now()-e).getUTCFullYear()-1970)},e.closeDialog=function(){o.hide()}}]),app.controller("bookingCtrl",["$scope","$state","$rootScope","$toast","$stateParams","$mdDialog","$firebaseObject","$http",function(e,t,a,r,n,o,i,s){e.today=moment(),e.todayIndex=e.today.day(),e.currentWeek=!0,e.weekIndex=0,e.weekStat={startOfWeek:moment().startOf("week").format("D-M-Y"),endOfWeek:moment().endOf("week").format("D-M-Y")},e.dayObjects=[],e.weekIsFree=!1,e.startTime=null,e.endTime=null,e.selectedDay=null,e.duration=null,e.cost=0,e.selectedChildren=null,e.bookingsLoaded=!1,e.fetchBookings=function(t){e.bookingsLoaded=!1;var r=a.database.child("availability/"+n.uid+"/"+moment(t).startOf("week").valueOf());e.bookings=i(r),e.bookings.$loaded(function(){e.bookingsLoaded=!0})},e.updateDate=function(t){e.weekNumber=t.format("w"),0!=e.weekIndex&&t.startOf("week"),e.dayOfMonth=t.format("D"),e.month=t.format("MMM"),e.dayOfWeek=t.format("dddd"),e.fetchBookings(t.valueOf())},e.updateDate(e.today),e.createDays=function(t){e.updateDate(t);for(var a=0;a<7;a++)day=t.startOf("week").add(a,"days"),e.dayObjects[a]={dayOfWeek:day.format("dddd"),moment:angular.copy(day),ms:day.valueOf(),date:day.format("D/MM")}},e.createDays(moment()),e.$watch("weekIndex",function(){0==e.weekIndex&&(e.currentWeek=!0)}),e.nextWeek=function(){return e.weekIndex>6?void(e.maxHistory=!0):(e.currentWeek=!1,e.weekIndex+=1,void e.createDays(moment().add(e.weekIndex,"weeks")))},e.previousWeek=function(){if(0==e.weekIndex)return void(e.currentWeek=!0);e.maxHistory=!1,e.currentTime=moment().add(e.weekIndex,"w"),e.weekIndex-=1;var t=moment(e.currentTime).subtract(1,"w");e.createDays(t)};var d=a.database.child("babysitters/"+n.uid);e.babysitter=i(d),e.babysitter.$loaded(function(){}),e.updateAges=function(){for(var t=0;t<e.children.length;t++){var a=moment(new Date(e.children[t].birthday)),r=moment(a).fromNow(!0);e.children[t].age=r}},e.book=function(t,a){e.selectedDay=moment(t).format("MMMM D"),e.createTimes(t),o.show({contentElement:"#bookDialog",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!0})},e.createTimes=function(t){e.day=t,e.times=[];for(var a=0;a<=48;a++){var r={ms:moment(t).startOf("day").add(30*a,"m").valueOf(),format:moment(t).startOf("day").add(30*a,"m").format("hh:mm A"),moment:moment(t).startOf("day").add(30*a,"m").format("hh:mm A")};for(key in e.bookings[t])r.ms>=e.bookings[t][key].startTime&&r.ms<=e.bookings[t][key].endTime&&(r.unavailable=!0);var n=r.ms-moment(t).startOf("day").valueOf(),o=moment(t).day();(n<e.babysitter.workHours[o].startTime||n>e.babysitter.workHours[o].endTime)&&(r.unavailable=!0),e.times.push(r)}},e.calcDuration=function(){if(null!=e.endTime&&null!=e.startTime){var t=moment.duration(e.endTime.ms-e.startTime.ms),a=t.get("hours"),r=t.get("minutes");a>=1?r>0?1==a?e.duration=a+" hour and "+r+" minutes":e.duration=a+" hours and "+r+" minutes":1==a?e.duration=a+" hour":e.duration=a+" hours":e.duration=r+" minutes",e.calcCost()}},e.calcCost=function(){if(null!=e.selectedChildren){e.cost=0;for(var t=0;t<e.selectedChildren.length;t++){var a=moment().diff(moment(e.selectedChildren[t].birthday),"years");switch(!0){case a>0&&a<3:e.cost+=e.babysitter.pricing[0].rate;break;case a>1&&a<6:e.cost+=e.babysitter.pricing[1].rate;break;case a>4&&a<9:e.cost+=e.babysitter.pricing[2].rate;break;case a>7&&a<13:e.cost+=e.babysitter.pricing[3].rate;break;case a>12:e.cost+=e.babysitter.pricing[4].rate}}e.cost=e.cost*(e.endTime.ms-e.startTime.ms)/36e5,e.babysitter.pricing}},e.closeDialog=function(){o.hide().then(function(){e.startTime=null,e.endTime=null,e.duration=null,e.cost=0,e.selectedChildren=null})},e.confirmBooking=function(){s({method:"POST",url:"/booking/create",api:!0,data:{startTime:e.startTime.ms,endTime:e.endTime.ms,day:e.day,parent:{id:e.currentUser.$id,street:e.currentUser.street,zipcode:e.currentUser.zipCode,children:e.selectedChildren,email:e.currentUser.email,name:e.currentUser.name},babysitter:{id:n.uid,email:e.babysitter.email,name:e.babysitter.name}}}).then(function(t){r("Booking successful"),e.closeDialog()}).catch(function(t){e.closeDialog(),r("Server error")})}}]),app.controller("bookingDetails",["$scope","$state","$rootScope","$toast","$firebaseObject","$stateParams","$mdDialog","$http",function(e,t,a,r,n,o,i,s){e.bookingLoaded=!1,e.companyEmail,e.calculateAge=function(e){return Math.abs(new Date(Date.now()-e).getUTCFullYear()-1970)},a.$watch("currentUserLoaded",function(){if(a.currentUser){var i=a.database.child("bookingStatus/"+a.currentUser.$id+"/"+o.id);e.booking=n(i),e.booking.$loaded().then(function(a){e.bookingLoaded=!0,null===a.$value&&(r("Booking not found"),t.go("accountPage"))}).catch(function(e){})}}),e.report=function(t){a.database.child("company/email").once("value").then(function(t){e.companyEmail=t.val()}).catch(function(e){}),i.show({contentElement:"#reportDialog",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0})},e.closeDialog=function(){i.hide()},e.cancelBooking=function(t){var a=i.confirm().title("Are you sure?").textContent("This will cancel the booking").ariaLabel("Cancel booking").targetEvent(t).ok("Cancel booking").cancel("Don't cancel booking");i.show(a).then(function(){s({method:"POST",url:"/booking/cancel",api:!0,data:{bookingID:e.booking.$id,parentID:e.booking.parent.id,babysitterID:e.booking.babysitter.id}})},function(){})}}]),app.controller("childrenCtrl",["$scope","$rootScope","$toast","$state","$firebaseArray","$stateParams","$timeout",function(e,t,a,r,n,o,i){e.children=[{birthday:null,name:null}],e.emptyChildren=!0,e.maxChildren=!1,e.remoteChildrenLoaded=!1,e.remoteChildren=[],e.editMode=!1,"true"===o.edit&&(e.editMode=!0,e.children=[]);var s=moment.duration(16,"years");e.minDate=moment().subtract(s,"years").toDate(),e.maxDate=moment().subtract(1,"years").toDate(),t.$watch("currentUserLoaded",function(){if(void 0!==t.currentUser){var a=t.currentUser.$id;e.remoteChildren=n(e.database.child("users/"+a+"/children")),e.remoteChildren.$loaded(function(){if(e.remoteChildrenLoaded=!0,e.editMode)for(var t=0;t<e.remoteChildren.length;t++)e.toPushChild=angular.copy(e.remoteChildren[t]),e.toPushChild.birthday=new Date(e.toPushChild.birthday),e.children.push(e.toPushChild),e.updateAges()}),e.remoteChildren.$watch(function(t){e.remoteChildren.length+e.children.length>=3&&(e.maxChildren=!0)})}}),e.$watchCollection("children",function(){e.emptyChildren=!1,e.children.length>2&&(e.maxChildren=!0),0==e.children.length&&0==e.remoteChildren.length&&(e.emptyChildren=!0),e.remoteChildren.length+e.children.length>=3&&(e.maxChildren=!0)}),e.updateAges=function(){for(var t=0;t<e.children.length;t++){var a=moment(new Date(e.children[t].birthday)),r=moment(a).fromNow(!0);e.children[t].age=r}},e.addChildForm=function(){e.children.push({birthday:null,name:null})},e.removeChild=function(t){var r=e.children.indexOf(t);e.children.splice(r,1),e.maxChildren=!1,e.remoteChildren.$remove(r).then(function(){a(t.name+" removed")})},e.saveChild=function(r){e.database.child("users/"+t.currentUser.$id+"/children/"+r.$id).update({name:r.name,birthday:r.birthday.getTime()}).then(function(e){a("Child edited")}).catch(function(e){a("Child editing failed")})},e.addChild=function(t,r,n){e.remoteChildren.length>=3?(a("You already have 3 children"),e.maxChildren=!0):e.remoteChildren.$add({name:t.name,birthday:t.birthday.getTime()}).then(function(e){a(t.name+" added")}).catch(function(e){a("Adding child failed")})}}]),app.controller("findCtrl",["$scope","$state","$rootScope","$toast","$firebaseObject","$mdDialog","$http",function(e,t,a,r,n,o,i){e.date=null,e.today=new Date,e.maxDate=moment().add(8,"weeks").toDate(),e.endTime=null,e.startTime=null,e.selectedChildren={},e.matches=[],e.hideForm=!1,e.zeroChildren=!0,a.database.child("company/phoneNumber").once("value").then(function(t){e.phonenumber=t.val()}),a.$watch("currentUserLoaded",function(){a.currentUserLoaded&&a.currentUser.children&&(e.zeroChildren=!1)}),e.times=[];for(var s=0;s<=48;s++){var d={ms:18e5*s,format:moment().startOf("day").add(30*s,"m").format("hh:mm A")};e.times.push(d)}e.reset=function(){e.matches=[],e.hideForm=!1},e.calcCost=function(t){if(t){for(var a=0,r=0;r<e.selectedChildren.length;r++){var n=moment().diff(moment(e.selectedChildren[r].birthday),"years");switch(!0){case n>0&&n<3:a+=t[0].rate;break;case n>1&&n<6:a+=t[1].rate;break;case n>4&&n<9:a+=t[2].rate;break;case n>7&&n<13:a+=t[3].rate;break;case n>12:a+=t[4].rate}}return a=a*(e.endTime.ms-e.startTime.ms)/36e5}},e.find=function(){e.searching=!0;i({method:"POST",url:"/find",api:!0,data:{startTime:e.startTime.ms,endTime:e.endTime.ms,date:e.date.getTime()}}).then(function(t){e.searching=!1,e.hideForm=!0,e.matches=t.data}).catch(function(t){o.show(o.alert().clickOutsideToClose(!0).title("Cannot find a babysitter").textContent("Please call us instead at "+e.phonenumber).ariaLabel("Cannot find a babysitter").ok("Ok")),e.searching=!1})},e.book=function(t){i({method:"POST",url:"/booking/create",api:!0,data:{startTime:moment(e.date.getTime()).add(e.startTime.ms,"ms").valueOf(),endTime:moment(e.date.getTime()).add(e.endTime.ms,"ms").valueOf(),day:e.date.getTime(),parent:{id:e.currentUser.$id,street:e.currentUser.street,zipcode:e.currentUser.zipCode,children:e.selectedChildren,email:e.currentUser.email,name:e.currentUser.name},babysitter:{id:t.uid,email:t.email,name:t.name}}}).then(function(e){o.show(o.alert().clickOutsideToClose(!0).title("Booking successful").textContent("An email is sent with further details.").ariaLabel("Booking successful").ok("Ok"))}).catch(function(e){r("Booking failed")})}}]),app.controller("mainCtrl",["$scope","$state","$rootScope","$toast","$firebaseAuth","$firebaseObject","$mdDialog",function(e,t,a,r,n,o,i){e.state=t,e.user={},a.navOpen=!1,e.navTapped=!1,e.auth=n(),a.slideAway=function(){document.querySelector("#sideNav").className="mobile",document.querySelector("#overlay").className="mobile fadeOut",setTimeout(function(){document.querySelector("#overlay").className="mobile"},300)},e.toggleNav=function(){setTimeout(function(){e.navTapped=!1},300),e.navTapped||(a.navOpen?e.slideAway():(document.querySelector("#sideNav").className+=" show",document.querySelector("#overlay").className+=" show"),a.navOpen=!a.navOpen,e.navTapped=!0)},e.signInWithGoogle=function(){var a=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(a).then(function(t){return e.database.child("users/"+t.user.uid).once("value")}).then(function(e){null==e.val()?(r("Please Register First"),t.go("register",{googleLogin:!0})):t.go("accountPage")}).catch(function(e){r("Google Login Failed")})},e.forgotPassword=function(){i.show({contentElement:"#forgotPassword",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0})},e.requestResetLink=function(){firebase.auth().sendPasswordResetEmail(e.user.email).then(function(e){r("Password reset link sent")}).catch(function(e){r("Password reset link not sent")}),i.hide()},e.closeDialog=function(){i.hide()},e.login=function(){firebase.auth().signInWithEmailAndPassword(e.user.email,e.user.password).then(function(n){a.authStateLoaded=!1,e.fetchUserData(n.uid),t.go("babysitters"),r("Welcome!")}).catch(function(e){"auth/user-not-found"==e.code&&r("Unrecognized email"),"auth/wrong-password"==e.code&&r("Wrong password")})},e.logout=function(){firebase.auth().signOut().then(function(){a.loggedIn=!1,window.location.reload(),r("Logged out!")},function(e){r("Logout failed!")})}}]),app.controller("registerCtrl",["$scope","$state","$rootScope","$toast","$stateParams","$mdDialog",function(e,t,a,r,n,o){e.user={photoURL:"https://i.gyazo.com/7fe293e6af9d0bc2dd9fe105679b21e1.png",password:null,passwordRepeat:null},e.user.userType={parent:!1,babySitter:!1},a.$watch("loggedIn",function(){a.loggedIn&&"google.com"==a.authData.providerData[0].providerId&&e.filledLoggedInGoogleData()}),e.filledLoggedInGoogleData=function(){if(n.googleLogin||a.loggedIn===!0){e.passwordChecked=!0,e.googleLoginFinished=!0;var t=firebase.auth().currentUser;e.user.name=t.displayName,e.user.uid=t.uid,e.user.photoURL=t.photoURL,e.user.email=t.email}},e.birthDay=null;var i=moment.duration(18,"years");e.maxDate=moment().subtract(i).toDate(),e.passwordChecked=!1,e.reDoLoginInfo=function(){e.passwordChecked=!1,e.user.password="",e.user.passwordRepeat=""},e.checkPassword=function(){e.user.password.length>=7&&e.user.password===e.user.passwordRepeat?e.passwordChecked=!0:e.passwordChecked=!1},e.signUpWithEmail=function(){e.withEmail=!0,e.chosen=!0},e.check=function(){},e.checkCheckbox=function(){(e.user.userType.parent||e.user.userType.babySitter)&&(e.userChosen=!0)},e.register=function(){return e.googleLoginFinished?void e.registerInDatabase(e.user.uid):e.user.password!==e.user.passwordRepeat?void r("Passwords don't match"):void firebase.auth().createUserWithEmailAndPassword(e.user.email,e.user.password).then(function(t){firebase.auth().signInWithEmailAndPassword(e.user.email,e.user.password).then(function(t){e.registerInDatabase(t.uid)}).catch(function(e){})}).catch(function(e){e.code,e.message;r("auth/email-already-in-use"==e.code?"Email Already In Use.":"Registration Failed.")})},e.resetEmailChoice=function(){e.withEmail=!1,e.chosen=!1},e.signInWithGoogle=function(){var t=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(t).then(function(t){t.credential.accessToken,t.user;e.$apply(function(){e.passwordChecked=!0,e.googleLoginFinished=!0,e.user.name=t.user.displayName,e.user.uid=t.user.uid,e.user.photoURL=t.user.photoURL,e.user.email=t.user.email})}).catch(function(e){r("Registration with Google failed")})},e.registerInDatabase=function(n){var o={};e.user.birthDay=e.birthDay.getTime(),delete e.user.password,delete e.user.passwordRepeat,e.user.userType.babySitter===!0&&(o["babysitters/"+n]={workHours:a.defaultWorkHours,pricing:a.defaultAgeGroups,photoURL:e.user.photoURL,locationCity:e.user.locationCity,birthDay:e.user.birthDay,email:e.user.email,name:e.user.name},e.user.pricing=a.defaultAgeGroups,e.user.workHours=a.defaultWorkHours),o["users/"+n]=e.user,e.database.update(o).then(function(n){r("Registration successful"),e.user.userType.babySitter&&e.user.userType.parent&&t.go("accountPage"),e.user.userType.babySitter&&t.go("accountPage"),e.user.userType.parent&&t.go("booking"),e.$apply(function(){a.incompleteData=!1})}).catch(function(e){r("Registration failed!")})}}]);